<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=1920, height=1080">
    <title>Slide 5: Tactical Cockpit</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Black+Ops+One&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@500;700;900&display=swap');

        /* --- Glitch Transition Overlay --- */
        .transition-overlay {
            position: fixed;
            inset: 0;
            background: #000;
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: glitch-out 1.5s cubic-bezier(1, 0, 0, 1) forwards;
            pointer-events: none;
        }

        .transition-overlay::before {
            content: "SYSTEM_INIT :: TACTICAL_VIEW";
            font-family: 'Orbitron', monospace;
            font-size: 40px;
            color: #00ff00;
            text-shadow: 0 0 10px #00ff00;
            animation: blink 0.1s infinite;
        }

        @keyframes glitch-out {
            0% { clip-path: inset(0 0 0 0); }
            20% { clip-path: inset(20% 0 0 0); }
            40% { clip-path: inset(20% 0 20% 0); }
            60% { clip-path: inset(0 0 80% 0); }
            80% { clip-path: inset(80% 0 0 0); }
            100% { clip-path: inset(100% 0 0 0); opacity: 0; }
        }

        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }

        :root {
            --hud-color: #00f3ff;
            --hud-dim: rgba(0, 243, 255, 0.2);
            --alert-color: #ff3366;
            --bg-color: #050a10;
            --panel-bg: rgba(10, 20, 30, 0.9);
            --matrix-green: #00ff41;
            --warn-color: #ffcc00;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            padding: 0;
            width: 1920px;
            height: 1080px;
            background: var(--bg-color);
            font-family: 'Orbitron', 'Microsoft JhengHei', 'Noto Sans TC', sans-serif;
            overflow: hidden;
            color: white;
        }

        /* --- 1. Background World (Battlefield) --- */
        .viewport-container {
            position: absolute;
            inset: 0;
            perspective: 1000px;
            z-index: 0;
            overflow: hidden;
            background: radial-gradient(circle at center, #0b1021 0%, #000000 100%);
        }

        .world-mover {
            position: absolute;
            inset: 0;
            transform-style: preserve-3d;
            will-change: transform;
        }

        .star-field {
            position: absolute;
            inset: -100%;
            width: 300%;
            height: 300%;
            background-image: 
                radial-gradient(white 2px, transparent 2px),
                radial-gradient(rgba(255, 255, 255, 0.5) 1px, transparent 1px);
            background-size: 100px 100px, 200px 200px;
            transform: translateZ(-800px);
            animation: starMove 60s linear infinite;
            opacity: 0.6;
        }

        .digital-terrain {
            position: absolute;
            bottom: -100%;
            left: -100%;
            width: 300%;
            height: 300%;
            background-image: 
                linear-gradient(var(--hud-dim) 1px, transparent 1px),
                linear-gradient(90deg, var(--hud-dim) 1px, transparent 1px);
            background-size: 100px 100px;
            transform: rotateX(85deg) translateZ(-200px);
            animation: terrainMove 20s linear infinite;
            -webkit-mask-image: linear-gradient(to top, black 20%, transparent 90%);
            mask-image: linear-gradient(to top, black 20%, transparent 90%);
            opacity: 0.3;
        }

        #particleSystem {
            position: absolute;
            inset: 0;
            pointer-events: none;
            transform-style: preserve-3d;
            z-index: 10; /* Ensure above terrain/stars */
        }
        
        .particle {
            position: absolute;
            background: white;
            will-change: transform, opacity;
            box-shadow: 0 0 10px white;
        }

        .particle.debris { width: 3px; height: 3px; background: #888; border-radius: 50%; }
        .particle.star { width: 2px; height: 2px; background: white; box-shadow: 0 0 4px white; border-radius: 50%; }
        .particle.rock { 
            background: #333; 
            width: 80px; height: 80px; 
            box-shadow: inset 5px 5px 20px rgba(0,0,0,1), inset -5px -5px 20px rgba(255,255,255,0.1);
        }
        .particle.bolt { width: 400px; height: 3px; background: linear-gradient(90deg, transparent, var(--hud-color), white); box-shadow: 0 0 20px var(--hud-color); }

        /* Hyperdrive State */
        body.hyperdrive .digital-terrain { animation: terrainMove 0.2s linear infinite; opacity: 0.8; filter: drop-shadow(0 0 10px var(--hud-color)); }

        @keyframes terrainMove {
            from { background-position: 0 0; }
            to { background-position: 0 100px; }
        }

        /* --- 2. Cockpit Overlay --- */
        .cockpit-overlay {
            position: absolute;
            inset: 0;
            z-index: 100;
            pointer-events: none;
            box-shadow: inset 0 0 150px rgba(0,0,0,0.9);
            background: 
                linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), 
                linear-gradient(90deg, rgba(255, 0, 0, 0.03), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.03));
            background-size: 100% 4px, 6px 100%;
            mix-blend-mode: overlay;
        }

        .cockpit-frame {
            position: absolute;
            inset: 20px;
            border: 2px solid var(--hud-dim);
            clip-path: polygon(
                0 0, 20% 0, 25% 8%, 75% 8%, 80% 0, 100% 0,
                100% 65%, 95% 70%, 95% 100%,
                5% 100%, 5% 70%, 0 65%
            );
            z-index: 90;
            pointer-events: none;
        }

        /* --- 3. Top HUD Bar --- */
        .top-hud {
            position: absolute;
            top: 30px;
            left: 50%;
            transform: translateX(-50%);
            width: 80%; /* Wider to prevent cutoff */
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 15px 80px;
            background: linear-gradient(90deg, transparent, var(--panel-bg) 20%, var(--panel-bg) 80%, transparent);
            border-bottom: 2px solid var(--hud-color);
            z-index: 95;
            clip-path: polygon(0 0, 100% 0, 95% 100%, 5% 100%); /* Less aggressive slope */
        }

        .mission-title {
            font-family: 'Microsoft JhengHei', sans-serif;
            font-weight: 900;
            font-size: 48px;
            color: white;
            text-shadow: 0 0 20px var(--hud-color);
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        .coordinates {
            font-family: 'Share Tech Mono', monospace;
            color: var(--hud-color);
            font-size: 24px;
            text-align: right;
            line-height: 1.4;
            text-shadow: 0 0 5px var(--hud-color);
        }

        .target-highlight {
            font-size: 48px;
            font-family: 'Black Ops One';
            color: var(--alert-color);
            text-shadow: 0 0 20px var(--alert-color);
            margin-bottom: 5px;
            letter-spacing: 2px;
        }

        /* --- 4. Quest Panel (RPG Style) --- */
        .quest-panel {
            position: absolute;
            top: 200px;
            left: 80px;
            width: 380px;
            background: rgba(0, 20, 40, 0.6);
            border-left: 4px solid var(--hud-color);
            padding: 20px;
            z-index: 95;
            clip-path: polygon(0 0, 100% 0, 100% 85%, 85% 100%, 0 100%);
            -webkit-backdrop-filter: blur(5px);
            backdrop-filter: blur(5px);
        }

        .quest-header {
            font-family: 'Black Ops One';
            font-size: 28px;
            color: var(--hud-color);
            margin-bottom: 20px;
            border-bottom: 1px solid var(--hud-dim);
            padding-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .quest-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .quest-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px;
            background: rgba(0, 20, 40, 0.8);
            border: 1px solid var(--hud-dim);
            transition: all 0.3s;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
        }

        .quest-item:hover {
            background: rgba(0, 243, 255, 0.1);
            border-color: var(--hud-color);
        }

        .quest-item.completed {
            background: rgba(0, 255, 65, 0.1);
            border-color: var(--matrix-green);
        }
        
        .quest-item.completed .quest-text,
        .quest-item.completed .quest-checkbox {
            color: var(--matrix-green);
            text-shadow: 0 0 5px var(--matrix-green);
        }

        .quest-checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid currentColor;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 16px;
            color: var(--hud-color);
        }

        .quest-text {
            font-family: 'Microsoft JhengHei', 'Orbitron', sans-serif;
            font-weight: 900;
            font-size: 20px;
            letter-spacing: 1px;
            color: var(--hud-color);
            text-shadow: 0 0 5px var(--hud-dim);
        }

        /* --- 5. Center Target Display --- */
        .target-display {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -60%);
            z-index: 90;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            pointer-events: none; /* Let clicks pass through unless specifically targeting */
        }

        .reticle-ring {
            position: absolute;
            width: 500px;
            height: 500px;
            border: 2px solid var(--alert-color);
            border-radius: 50%;
            opacity: 0.3;
            animation: spinSlow 20s linear infinite;
        }
        
        .reticle-ring::before {
            content: '';
            position: absolute;
            inset: -10px;
            border: 2px dashed var(--alert-color);
            border-radius: 50%;
            animation: spinReverse 30s linear infinite;
        }

        .target-label {
            font-family: 'Black Ops One';
            font-size: 72px;
            color: var(--alert-color);
            text-shadow: 0 0 30px var(--alert-color), 4px 4px 0px black;
            text-align: center;
            line-height: 1;
            z-index: 100;
            animation: pulseAlert 2s infinite;
        }

        .target-sub {
            font-family: 'Share Tech Mono';
            font-size: 28px;
            color: white;
            margin-top: 10px;
            letter-spacing: 6px;
            background: var(--alert-color);
            padding: 5px 20px;
            text-shadow: none;
        }

        /* --- 6. Bottom Dashboard (Cockpit Controls) --- */
        .dashboard-console {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 250px;
            background: linear-gradient(to top, #0a0a0a, #151515 30%, transparent);
            display: flex;
            align-items: flex-end;
            padding: 0 60px 30px 60px;
            z-index: 95;
            gap: 30px;
            justify-content: space-between;
        }

        /* Module Frames */
        .module-frame {
            background: var(--panel-bg);
            border: 1px solid #334155;
            border-top: 3px solid var(--hud-color);
            padding: 15px;
            clip-path: polygon(10% 0, 100% 0, 100% 100%, 0 100%, 0 15%);
        }

        /* Left: Radar (Compact) */
        .radar-module {
            width: 200px;
            height: 180px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .radar-screen {
            width: 120px;
            height: 120px;
            border: 2px solid var(--hud-color);
            border-radius: 50%;
            background: radial-gradient(transparent 30%, rgba(0, 243, 255, 0.1)),
                        linear-gradient(0deg, transparent 49%, var(--hud-dim) 50%, transparent 51%),
                        linear-gradient(90deg, transparent 49%, var(--hud-dim) 50%, transparent 51%);
            position: relative;
            overflow: hidden;
            box-shadow: inset 0 0 20px rgba(0, 243, 255, 0.2);
        }

        .radar-sweep {
            position: absolute;
            inset: 0;
            background: conic-gradient(from 0deg, transparent 70%, var(--hud-color));
            border-radius: 50%;
            animation: spinSlow 3s linear infinite;
            opacity: 0.5;
        }

        .radar-blip {
            position: absolute;
            width: 4px; 
            height: 4px;
            background: var(--matrix-green);
            border-radius: 50%;
            box-shadow: 0 0 4px var(--matrix-green);
            opacity: 0;
            animation: blipFade 2s ease-out forwards;
        }

        .radar-blip.enemy {
            background: var(--alert-color);
            box-shadow: 0 0 6px var(--alert-color);
            width: 6px; 
            height: 6px;
            animation: blipPulse 0.5s infinite alternate;
        }

        .scanner-warning {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--alert-color);
            font-family: 'Black Ops One';
            font-size: 12px;
            background: rgba(255, 0, 0, 0.2);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
        }

        @keyframes blipFade { 0% { opacity: 1; transform: scale(1); } 100% { opacity: 0; transform: scale(2); } }
        @keyframes blipPulse { 0% { opacity: 1; } 100% { opacity: 0.5; } }

        /* Center: Flight Controls */
        .control-cluster {
            flex: 2;
            height: 200px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
            position: relative;
        }

        /* Main Launch Button */
        .launch-btn {
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid var(--hud-color);
            color: var(--hud-color);
            font-family: 'Black Ops One';
            font-size: 32px;
            padding: 15px 50px;
            cursor: pointer;
            position: relative;
            transition: all 0.3s;
            text-transform: uppercase;
            box-shadow: 0 0 20px rgba(0, 243, 255, 0.3);
            clip-path: polygon(10% 0, 100% 0, 100% 70%, 90% 100%, 0 100%, 0 30%);
            margin-bottom: 20px;
        }

        .launch-btn:hover {
            background: var(--hud-color);
            color: black;
            box-shadow: 0 0 50px rgba(0, 243, 255, 0.8);
            transform: scale(1.05);
        }

        /* Mission Complete Button (Hidden initially) */
        .complete-btn {
            display: none; /* Toggled via JS */
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid var(--matrix-green);
            color: var(--matrix-green);
            font-family: 'Black Ops One';
            font-size: 40px;
            padding: 20px 60px;
            cursor: pointer;
            text-transform: uppercase;
            box-shadow: 0 0 30px var(--matrix-green);
            animation: pulseGreen 1s infinite alternate;
            position: absolute;
            bottom: 80px;
            z-index: 200;
        }

        .complete-btn:hover {
            background: var(--matrix-green);
            color: black;
            transform: scale(1.1);
        }

        /* Throttle / Status Indicators */
        .status-panel {
            display: flex;
            gap: 20px;
            margin-top: 10px;
        }

        .status-light {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .light-bulb {
            width: 40px;
            height: 10px;
            background: #333;
            border: 1px solid #555;
        }

        .light-bulb.active {
            background: var(--hud-color);
            box-shadow: 0 0 10px var(--hud-color);
        }
        
        .light-bulb.warn {
            background: var(--warn-color);
            box-shadow: 0 0 10px var(--warn-color);
        }

        .status-label {
            font-family: 'Share Tech Mono';
            font-size: 12px;
            color: #888;
        }

        /* Right: Future Ops */
        .future-ops-module {
            width: 300px;
            height: 180px;
            display: flex;
            flex-direction: column;
        }

        .ops-header {
            font-family: 'Share Tech Mono';
            color: var(--hud-color);
            font-size: 16px;
            margin-bottom: 10px;
            border-bottom: 1px solid var(--hud-dim);
        }

        .ops-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            overflow-y: auto;
        }

        .ops-item {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            color: #aaa;
            padding: 5px;
            background: rgba(255,255,255,0.05);
        }

        .ops-id { color: var(--hud-dim); font-weight: bold; }

        /* Animations */
        @keyframes spinSlow { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes spinReverse { from { transform: rotate(360deg); } to { transform: rotate(0deg); } }
        @keyframes pulseAlert { 0%, 100% { text-shadow: 0 0 30px var(--alert-color); opacity: 1; } 50% { text-shadow: 0 0 60px var(--alert-color); opacity: 0.8; } }
        @keyframes pulseGreen { 0% { box-shadow: 0 0 20px var(--matrix-green); } 100% { box-shadow: 0 0 50px var(--matrix-green); } }

    </style>
</head>

<body>
    <div class="transition-overlay"></div>
    <div class="cockpit-overlay"></div>
    <div class="cockpit-frame"></div>
    
    <div class="viewport-container">
        <div class="world-mover">
            <div class="star-field"></div>
            <div class="digital-terrain"></div>
            <div id="particleSystem"></div>
        </div>
    </div>

    <!-- Top HUD -->
    <div class="top-hud">
        <div class="mission-title">戰術演示：研究行動</div>
        <div class="coordinates">
            <div class="target-highlight">TARGET: ZERO_HALLUCINATION</div>
            <div class="nav-data">
                LAT: <span id="lat">34.592</span> | LNG: <span id="lng">12.404</span> | ALT: <span id="alt">2500</span>
            </div>
        </div>
    </div>

    <!-- Left: RPG Quest Panel -->
    <div class="quest-panel">
        <div class="quest-header">
            <span>⚡ MISSION LOG</span>
        </div>
        <div class="quest-list">
            <div class="quest-item" id="q1">
                <div class="quest-checkbox"></div>
                <div class="quest-text">資料上傳</div>
            </div>
            <div class="quest-item" id="q2">
                <div class="quest-checkbox"></div>
                <div class="quest-text">情報分析</div>
            </div>
            <div class="quest-item" id="q3">
                <div class="quest-checkbox"></div>
                <div class="quest-text">精準提問</div>
            </div>
            <div class="quest-item" id="q4">
                <div class="quest-checkbox"></div>
                <div class="quest-text">來源鎖定</div>
            </div>
        </div>
    </div>

    <!-- Center: Target Reticle (Text Removed) -->
    <div class="target-display">
        <div class="reticle-ring"></div>
        <!-- Text removed as requested -->
    </div>

    <!-- Bottom Dashboard: Controls -->
    <div class="dashboard-console">
        <!-- Left: Scanner -->
        <div class="module-frame radar-module">
            <div style="width:100%; text-align:center; color:var(--hud-color); font-family:'Share Tech Mono'; margin-bottom:5px;">SCANNER</div>
            <div class="radar-screen">
                <div class="radar-sweep"></div>
                <div id="radarBlips"></div>
                <div class="scanner-warning" id="scannerWarn">WARNING</div>
            </div>
        </div>

        <!-- Center: Flight Controls -->
        <div class="control-cluster">
            <!-- Main Buttons -->
            <button class="launch-btn" id="launchBtn" onclick="engageThrusters()">
                ENGAGE THRUSTERS [啟動引擎]
            </button>

            <button class="complete-btn" id="completeBtn" onclick="completeMission()">
                MISSION COMPLETE [任務完成]
            </button>

            <!-- Status Lights -->
            <div class="status-panel">
                <div class="status-light">
                    <div class="light-bulb active" id="statusEng"></div>
                    <div class="status-label">ENGINE</div>
                </div>
                <div class="status-light">
                    <div class="light-bulb" id="statusThrust"></div>
                    <div class="status-label">THRUST</div>
                </div>
                <div class="status-light">
                    <div class="light-bulb warn" id="statusWeap"></div>
                    <div class="status-label">WEAPON</div>
                </div>
                <div class="status-light">
                    <div class="light-bulb active" id="statusSys"></div>
                    <div class="status-label">SYSTEM</div>
                </div>
            </div>
        </div>

        <!-- Right: Future Ops (Larger) -->
        <div class="module-frame future-ops-module">
            <div class="ops-header">
                <span>DEPLOYMENT QUEUE</span>
                <span style="float:right; color:var(--matrix-green)">ONLINE</span>
            </div>
            <div class="ops-list">
                <div class="ops-item">
                    <span class="ops-id">[02]</span>
                    <span>數據分析協議</span>
                    <span>PENDING</span>
                </div>
                <div class="ops-item">
                    <span class="ops-id">[03]</span>
                    <span>深潛行動執行</span>
                    <span>LOCKED</span>
                </div>
                <div class="ops-item">
                    <span class="ops-id">[04]</span>
                    <span>事實查核部署</span>
                    <span>STANDBY</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Flight & Particle System ---
            const container = document.getElementById('particleSystem');
            const world = document.querySelector('.world-mover');
            const radarScreen = document.getElementById('radarBlips');
            
            // Navigation Variables
            const latEl = document.getElementById('lat');
            const lngEl = document.getElementById('lng');
            const altEl = document.getElementById('alt');
            let lat = 34.592;
            let lng = 12.404;

            // Flight Physics
            let isHyperdrive = false; // Added missing declaration
            let currentSpeed = 0.1; // Start static
            let targetSpeed = 0.1;
            let acceleration = 0.05; // Smooth factor
            
            let flightX = 0; 
            let flightY = 0; 
            let targetX = 0;
            let targetY = 0;

            // Particle Pool
            const particles = [];
            const MAX_PARTICLES = 300; // Increased density

            class Particle {
                constructor() {
                    this.el = document.createElement('div');
                    this.el.classList.add('particle');
                    if (container) container.appendChild(this.el);
                    this.reset();
                }

                reset() {
                    // Spawn deep in Z
                    this.z = -4000 - Math.random() * 6000; 
                    
                    // Spawn in a cone towards viewer
                    // Use Gaussian-like distribution for more center focus
                    const spread = 5000;
                    const r = (Math.random() + Math.random() + Math.random()) / 3; // Bell curve
                    const angle = Math.random() * Math.PI * 2;
                    const dist = r * spread;
                    
                    this.x = Math.cos(angle) * dist;
                    this.y = Math.sin(angle) * dist * 0.6; // Wider aspect ratio
                    
                    // Rotation (Self-spin for rocks)
                    this.spin = Math.random() * 360;
                    this.spinSpeed = (Math.random() - 0.5) * 5;
                    
                    // Types
                    const rand = Math.random();
                    this.el.className = 'particle';
                    this.el.style.clipPath = 'none'; 
                    this.el.style.background = '';
                    this.el.style.boxShadow = '';
                    this.opacity = 1;
                    
                    if (rand > 0.98) { // Rocks (Rarer)
                        this.type = 'rock';
                        this.el.classList.add('rock');
                        this.baseScale = 0.8 + Math.random() * 2;
                        // Random polygon
                        const points = [];
                        const sides = 5 + Math.floor(Math.random() * 3);
                        for (let i = 0; i < sides; i++) {
                            const angle = (i / sides) * Math.PI * 2;
                            const r = 30 + Math.random() * 20; 
                            const px = 50 + Math.cos(angle) * r + '%';
                            const py = 50 + Math.sin(angle) * r + '%';
                            points.push(`${px} ${py}`);
                        }
                        this.el.style.clipPath = `polygon(${points.join(',')})`;
                        this.el.style.background = `hsl(0, 0%, ${20 + Math.random() * 10}%)`; 
                        
                    } else if (rand > 0.95) { // Bolts
                        this.type = 'bolt';
                        this.el.classList.add('bolt');
                        this.baseScale = 1;
                    } else if (rand > 0.7) { // Debris
                        this.type = 'debris';
                        this.el.classList.add('debris');
                        this.baseScale = 0.5 + Math.random();
                    } else { // Stars
                        this.type = 'star';
                        this.el.classList.add('star');
                        // Varied size and opacity for depth
                        this.baseScale = 0.2 + Math.random() * 1.5; 
                        this.opacity = 0.1 + Math.random() * 0.9;
                    }
                    
                    this.active = true;
                    this.updateTransform(2); // Init transform
                }

                update(speed) {
                    if (!this.active) return;

                    // Move Z forward
                    let moveSpeed = speed;
                    if (this.type === 'star') moveSpeed *= 0.8; 
                    if (this.type === 'bolt') moveSpeed *= 1.5;

                    this.z += moveSpeed * 20; 
                    this.spin += this.spinSpeed;
                    
                    if (this.z > 500) { 
                        this.reset();
                        if (this.type === 'rock' && isHyperdrive && Math.random() > 0.8) {
                            shakeScreen();
                        }
                    }
                    this.updateTransform(speed);
                }

                updateTransform(speed) {
                    // 1. Radial Rotation (The "Warp Tunnel" Effect)
                    // Calculate angle from center (0,0)
                    const angle = Math.atan2(this.y, this.x); // Radians
                    const angleDeg = angle * (180 / Math.PI);
                    
                    let stretch = 1;
                    if (this.type !== 'rock') {
                        stretch = 1 + (speed * 0.5); 
                    }
                    
                    let transform = `translate3d(${this.x}px, ${this.y}px, ${this.z}px)`;
                    
                    if (this.type === 'rock') {
                        transform += ` rotate(${this.spin}deg) scale(${this.baseScale})`;
                    } else {
                        transform += ` rotate(${angleDeg}deg) scaleX(${stretch * this.baseScale}) scaleY(${this.baseScale})`;
                    }
                    
                    this.el.style.transform = transform;
                    
                    // Fog
                    let op = this.opacity;
                    if (this.z < -3000) op = 0;
                    else if (this.z < -1000) op = op * ((this.z + 3000) / 2000);
                    
                    this.el.style.opacity = op;
                }
            }

            // Init Pool
            if (container) {
                for(let i=0; i<MAX_PARTICLES; i++) {
                    particles.push(new Particle());
                    // Pre-warm positions
                    particles[i].z = -4000 + Math.random() * 4500;
                }
            }

            function gameLoop() {
                // Smooth Speed
                currentSpeed += (targetSpeed - currentSpeed) * acceleration;

                if (isHyperdrive) { // Active Dodge
                    // Random walk for target
                    targetX += (Math.random() - 0.5) * 150;
                    targetY += (Math.random() - 0.5) * 80;
                    
                    // Clamp limits
                    targetX = Math.max(-1200, Math.min(1200, targetX));
                    targetY = Math.max(-600, Math.min(600, targetY));
                } else {
                    // Recenter
                    targetX *= 0.98;
                    targetY *= 0.98;
                }

                // Smooth follow
                flightX += (targetX - flightX) * 0.05;
                flightY += (targetY - flightY) * 0.05;

                // Camera Movement (World moves opposite)
                if (world) {
                    const yaw = -flightX * 0.02;   
                    const pitch = flightY * 0.02;  
                    const roll = -flightX * 0.03; 
                    
                    // Combine Translation (Dodging) and Rotation (Banking)
                    world.style.transform = `translate3d(${-flightX}px, ${flightY}px, 0) rotateY(${yaw}deg) rotateX(${pitch}deg) rotateZ(${roll}deg)`;
                }

                // Update Particles
                particles.forEach(p => p.update(currentSpeed));

                // Nav Data
                updateNavData(currentSpeed, flightY);

                // Random Radar Blips
                if (Math.random() > 0.97) createRadarBlip();

                requestAnimationFrame(gameLoop);
            }
            gameLoop();

            function shakeScreen() {
                document.body.classList.remove('shake');
                void document.body.offsetWidth; 
                document.body.classList.add('shake');
            }

            function createRadarBlip() {
                if (!radarScreen) return;
                const blip = document.createElement('div');
                blip.className = 'radar-blip';
                
                // Random pos (polar to Cartesian for circular distribution)
                const angle = Math.random() * Math.PI * 2;
                const r = Math.random() * 45; // % radius
                const rx = 50 + Math.cos(angle) * r; 
                const ry = 50 + Math.sin(angle) * r;
                
                blip.style.left = rx + '%';
                blip.style.top = ry + '%';
                
                // Enemy Chance
                if (Math.random() > 0.7) {
                    blip.classList.add('enemy');
                    triggerScannerWarning();
                }
                
                radarScreen.appendChild(blip);
                setTimeout(() => blip.remove(), 2000);
            }

            function triggerScannerWarning() {
                const warn = document.getElementById('scannerWarn');
                if (warn) {
                    warn.style.opacity = 1;
                    setTimeout(() => warn.style.opacity = 0, 800);
                }
            }

            // --- Navigation Data Logic ---
            function updateNavData(speed, altitudeOffset) {
                // Move "forward" means changing Lat/Lng continuously
                const speedFactor = speed * 0.0005;
                lat += speedFactor;
                lng += speedFactor * 0.5; 
                
                // Altitude based on "dodging" height + base
                let currentAlt = 2500 - (altitudeOffset * 2); 
                
                if (latEl) latEl.textContent = lat.toFixed(4);
                if (lngEl) lngEl.textContent = lng.toFixed(4);
                if (altEl) altEl.textContent = Math.floor(currentAlt);
            }

            // Global Functions
            window.engageThrusters = function() {
                isHyperdrive = true;
                targetSpeed = 5; // High speed rush
                document.body.classList.add('hyperdrive');
                
                // UI Updates
                const launchBtn = document.getElementById('launchBtn');
                const completeBtn = document.getElementById('completeBtn');
                if (launchBtn) launchBtn.style.display = 'none';
                if (completeBtn) completeBtn.style.display = 'block';
                
                const statusThrust = document.getElementById('statusThrust');
                if (statusThrust) {
                    statusThrust.classList.add('active');
                    statusThrust.style.boxShadow = "0 0 20px #00f3ff";
                }
            };

            window.completeMission = function() {
                isHyperdrive = false;
                targetSpeed = 0.1; // Slow down to static
                
                document.body.classList.remove('hyperdrive');
                
                // Allow grid to keep moving slowly
                const terrain = document.querySelector('.digital-terrain');
                if (terrain) terrain.style.animationDuration = '20s'; 

                const btn = document.getElementById('completeBtn');
                if (btn) {
                    btn.innerHTML = "OBJECTIVE SECURED";
                    btn.style.pointerEvents = 'none';
                    btn.style.background = "var(--matrix-green)";
                    btn.style.color = "black";
                }

                // Checklist
                const items = ['q1', 'q2', 'q3', 'q4'];
                let index = 0;
                function checkItem() {
                    if (index >= items.length) return;
                    const el = document.getElementById(items[index]);
                    if (el) {
                        el.classList.add('completed');
                        const checkbox = el.querySelector('.quest-checkbox');
                        if (checkbox) checkbox.innerHTML = '✓';
                    }
                    index++;
                    setTimeout(checkItem, 300);
                }
                checkItem();
            };
        });
    </script>
</body>
</html>